/*************************************************************************************************\
* Наименование: СКУД Заявление на отсутствие                                                       *
* Контур/Модуль: Кадры                                                                            *
* Примечание:                                                                                     *
*                                                                                                 *
* Вид работы  |Номер         |Дата    |Исполнитель              |Проект                           *
* ----------------------------------------------------------------------------------------------- *

\*************************************************************************************************/
#include GetKau.vih
#include GP_ZayavPitanie.vih
#include odecl.vih             // Функции склонения ФИО



#doc
Заявления на питание сотрудников
#end

//************************************************************
Interface GP_ZayavPitanie '' (,,sci17EnEsc), EscClose;
//************************************************************
Show At (,,120,30)
procedure AgreeZayavka; forward;
function GetStatusName(_status : word): forward;
//----------------------------------------
#Include ShowKau.Vpp
//----------------------------------------
// Forward
//----------------------------------------

//------------------------------------
// декларация сложного фильтра
//------------------------------------
#include GetKau.Var
//-------------------------------
//-------------------
//-------------------
//-----------------------------------------
// Фильтры
//-----------------------------------------
table struct tmp_Limitpitanie
(
   nrec : comp
  ,code : String
  ,name : String
)
with index
(
 ind0 = nrec
)
;
/*table struct tPodr
(
  nrec : comp
)
with index
(
 ind0 = nrec
)
;
*/
Create View
var
    iOdecl:declension;
   _ee: EmpElements;
   cRec
 , pGP_IIKO_Doc
 , pUserId : Comp;
   isProtect :boolean; //защищенный выбор
   isProtect_Set :boolean=false;// признак первой установки

  fCurMainFormatEdit:longint; // окно редактирования - определить в CmInit
  sTitle_InterFace
  ,sTitle_Window : string;
  _typeZayav : word;
    boVisibleRun:boolean; //тип запуска - false как объект
  boDataProtector : boolean;
   pStatus_GetDefault  : word; // статус по умолчанию

    _Kau_IIKOLIMIT
  , _Kau_system : word;
as select
   Zayavka.Nrec
 , If(Zayavka.cPersons    = 0h, '--выберите сотрудника--', #ShowKau(cgKau_Persons,Pers.nrec)) (Fieldname = PersonsFio, FieldTitle='ФИО сорудника')
 , If(Zayavka.CLIMITCATEGORY = 0h, '--выберите категорию лимита питания--', #ShowKau(_Kau_IIKOLIMIT,Zayavka.CLIMITCATEGORY)) (Fieldname=limitcategory, FieldTitle='Лимит категория питания')
 , If(Zayavka.cSystem = 0h, '--выберите систему питания--', #ShowKau(_Kau_system,Zayavka.cSystem)) (Fieldname=SystemPitanie, FieldTitle='Система питания')
   zayavka.Status   ('статус документа '):[list 0 'Оформляемый', 1 'Утвержден', 2 'Передан'], protect, skip;
 , GetStatusName(zayavka.Status) (Fieldname=StatusName, FieldTitle='Статус заявки на питание')
// ,if(isValid(tneMail), eMail.eMail,' -у сотрудника нет почты- ')  (fieldname = PERSEMAIL)
From
  persons ScudPers
, GP_ZAYAVKA_PITANIE zayavka
, catalogs Podr
, x$users UserInput
, x$users UserApprove
, Persons Pers
, KatOrg

, COMMUNICATIONS eMail
, spkau KauSystem
, tmp_Limitpitanie
//, ZAR_USER ZU
//, tPodr

where
((
   _datetime(0,0,0,0,0,0,0) <<= zayavka.INPUT_DATE (noindex)
and       zayavka.cSystem == KauSystem.nrec
 and zayavka.cPersons     == Pers.nrec
and  zayavka.cPodr        == podr.nrec
and  zayavka.CUSERINPUT   == Userinput.Atl_nrec
and  zayavka.CUSERAPPROVE == UserApprove.atl_nrec
and             Pers.nrec == eMail.PERSON
and                     3 == eMail.OBJTYPE
and     000A00000003995Dh == eMail.COMTYPE (noindex)// eMail
))
Bounds byNrec      pGP_IIKO_Doc == Zayavka.Nrec(noindex) ordered by TableOrder
Bounds byUserID    pUserId == Zayavka.Atl_owner(noindex)  ordered by TableOrder
//bounds buZarPodr   zayavka.cPodr /== tPodr.nrec
/*
(upper('CB\'+ZU.OWNNAME) = upper(XU.xu$loginname))
 inner join x$users XU on (#userid = XU.Atl_nrec)
 inner join ZAR_USER ZU on (upper('CB\'+ZU.OWNNAME) = upper(XU.xu$loginname))

bounds
     or  (kP.nrec in (Select UR.crecds
           from USERRIGHTS UR
           where ZU.OWNNAME = UR.OWNNAME
         )
    )
*/

;

function GetStatusName(_status : word): cacheable; {
 result := '--не известно--'
  case _status of
   0 : result := 'Оформляемый'
   1 : result := 'Утвержденный'
   2 : result := 'В очереди'
   3 : result := 'Передан'
   4 : result := 'Ошибка передачи'
  end;
}

//---------------------------
//
//---------------------------
#include GP_ZayavPitanie_FRDTS.vpp
//******************************************************************************
// Функции
//******************************************************************************
Procedure EnableDisableDelete(_Enable:boolean);
{ if _Enable
  { EnableCommand(cmDelete);
    EnableCommand(cmDeleteRecord);
  }
  else
  { DisableCommand(cmDelete);
    DisableCommand(cmDeleteRecord);
  }
} //Function EnableDisableDelete(_Enable:boolean);

Function SetDocFieldsState: boolean;
{
  Result:=true;
  var _CanDel   :boolean=true;
  var _CanChange:boolean=true;


  _CanDel := False;
  _CanDel := True;
  EnableDisableDelete(_CanDel);
  _CanChange := True;
  if(zayavka.output_DATE <> _datetime(0,0,0, 0,0,0,0))
   {
    cfsSetProp('i_SCREDIT_GP_STATUS.NAME','SKIP',TRUE);
    _CanChange := false;
    _CanDel := false;
   }
   else
   {
    cfsSetProp('i_SCREDIT_GP_STATUS.NAME','SKIP',false);
   }


  //if timelog_status>2 timelog('GP_SCUD_BASE->SetDocFieldsState:_CanChange='+string(_CanChange)+', CanDel='+string(_CanDel) );
  if _CanChange
  { if _CanDel
      SetHelpAndStatusContext(fCurMainFormatEdit, _FieldStatus, sci13478Esc, hcKeepCurrent);
    else
       SetHelpAndStatusContext(fCurMainFormatEdit, _FieldStatus, sci1478EscIns, hcKeepCurrent);
    SetInputLineFlags(fCurMainFormatEdit, _FieldStatus, inPickButton);
    cfsSetProp('i_SCREDIT_GP_STATUS.NAME','ButtonType',inPickButton);
  }
  else
  { if _CanDel
      SetHelpAndStatusContext(fCurMainFormatEdit, _FieldStatus, sci178Esc, hcKeepCurrent);
    else
      SetHelpAndStatusContext(fCurMainFormatEdit, _FieldStatus, sci1Esc, hcKeepCurrent);
    SetInputLineFlags(fCurMainFormatEdit, _FieldStatus, 0);
  }
} //Function SetDocFieldsState: boolean;

procedure SetEditMode(Value: boolean);
{
  if Value
    cfsSetProp(cfsGetCurrentContainerSelf, cfpPalette, wpBlueWindow);
  else
    cfsSetProp(cfsGetCurrentContainerSelf, cfpPalette, wpCyanWindow);

    cfsSetProp('i_SCREDIT_ZAYAVKA.DOCDATE', 'Skip', (not Value));
    cfsSetProp('i_SCREDIT_ZAYAVKA.NODOC'  , 'Skip', (not Value));
    cfsSetProp('i_SCREDIT_PERSONSFIO'     , 'Skip', (not Value));
    cfsSetProp('i_SCREDIT_SYSTEMPITANIE'  , 'Skip', (not Value));
    cfsSetProp('i_SCREDIT_LIMITCATEGORY'  , 'Skip', (not Value));
    cfsSetProp('i_SCREDIT_ZAYAVKA.PHONE'  , 'Skip', (not Value));
    cfsSetProp('i_SCREDIT_ZAYAVKA.EMAIL'  , 'Skip', (not Value));
  isProtect:= not Value;
  isProtect_Set:=true;
  SetDocFieldsState;
  //timelog(GetInterfaceName+'->SetEditMode finish=');
} //Procedure SetEditMode(_isEdit:boolean);

Function CanEditTbl:boolean;
{
  result:=false; //CanEdit(Zayavka.status);
  if zayavka.status = 0 then result:=true;

} //Function CanEditTbl:boolean;

Function Status_Init:boolean;
{
  Result:=True;
} //Function Status_Init(_wType:word):boolean;

  //-----------------------------------------------------

  // Поиск следующего номера документа
  //-----------------------------------------------------

  function GetNextDocNumber(InYear:word):string;
  var _DTBeg,_DTEnd:_datetime;
      _wTypeDoc:word;
  { _DTBeg:=_DateTime(1,1,InYear,0,0,0,0);
    _DTEnd:=_DateTime(31,12,InYear,23,59,0,0);
    _wTypeDoc:=_typeZayav;
    result:='';
    sql
      select max(GP_ZAYAVKA_PITANIE.NoDOC)
      from GP_ZAYAVKA_PITANIE
    where(:(_DTBeg)<=GP_ZAYAVKA_PITANIE.DocDate
      )
    into (result);

    if (Trim(result)='')
      result:='000001'
    else
      result:=NextNumStr(result);
  } //function GetNextDocNumber(InYear:word):string;


  //============================================
  // Получить статус по умолчанию
  //============================================
  Function GetStatus_Default:word;
  { Result := 0;
  } //Function GetStatus_Default:comp;




  //-------------------------------------------
  #doc
    Установить ограничения
  #end

//---------------------------------------------
// Тип документа
//---------------------------------------------

//---------------------------------------------

//-------------------------------------
// Защитить данные
//-------------------------------------


//-------------------------------------
// Защитить данные
//-------------------------------------
//-------------------------------------
//
//-------------------------------------
Procedure PositionChanged;
{
  SetEditMode(CanEditTbl);
  ReScanPanel(#Zayavka);
} //Function PositionChanged;

Procedure MakeBufferZayavka;
  { ClearBuffer(#Zayavka);
    Zayavka.Nrec       := GetNextNrec(#Zayavka,0) ;
    Zayavka.INPUT_DATE := _CurDateTime;
    Zayavka.noDoc      := GetNextDocNumber(year(Cur_Date));
    Zayavka.CUSERINPUT := UserID(); //UserAccessService.UserPersonsNRec;
    Zayavka.DocDate    := Cur_date;
    Zayavka.Status     := pStatus_GetDefault;
  } //Procedure MakeBufferGP_SCUD_Doc;

//========================================================
// Визуальная часть
//========================================================
//------------------------------------------------------------------------------
// Задание подписантов
//------------------------------------------------------------------------------

//------------------------------------------------------
// Окно редактирования документа
//------------------------------------------------------
Window wnEdit  '';
Show at (,,120,24);
Screen ScrEdit (,,sci18Esc);
//Show at (,,,7);
Table zayavka;
Fields
  zayavka.DocDate  ('Дата документа ',,sci138Esc): [12] ,NoProtect;
  zayavka.NoDoc    ('Номер документа')           : [10] ,NoProtect;
  StatusName       ('статус документа '):[list 0 'Оформляемый', 1 'Утвержден', 2 'Передан'], protect, skip;
  Userinput.XU$FULLNAME  ('Автор документа - кто занес в систему') : Protect, Skip;
  zayavka.INPUT_DATE ('Дата внесения в систему' ,,sci138Esc): [12] ,Protect, NoPickButton, Skip;
  UserApprove.XU$FULLNAME ('Утвердивший документа - кто утвердил') : Protect, Skip;
  zayavka.APPROVE_DATE ('Дата утверждения документа' ,,sci138Esc): [12] ,Protect, NoPickButton, Skip, {Font={Color=if(zayavka.APPROVE_DATE = _datetime(0,0,0,0,0,0,0), 0, 13)}};
  zayavka.output_DATE ('Дата передачи в IIKO' ,,sci138Esc): [12] ,Protect, NoPickButton, Skip, {Font={Color=if(Zayavka.output_DATE = _datetime(0,0,0,0,0,0,0),0,14)}};
  PersonsFio         ('Сотрудник',,sci138Esc):Protect,PickButton,NoDel, {Font={BackColor=if(Zayavka.cPersons<> 0h,0,ColorNeed)}};
  podr.code           ('Подразделение код') : skip;
  podr.name          ('Подразделение наименование') : skip;
  SystemPitanie      ('Система  питания',,sci138Esc):Protect,PickButton,NoDel, {Font={BackColor=if(Zayavka.cSystem <> 0h,0,ColorNeed)}};
  limitcategory      ('Категория лимита питания',,sci138Esc):Protect,PickButton,NoDel, {Font={BackColor=if(Zayavka.CLIMITCATEGORY<>0h,0,ColorNeed)}};
  zayavka.phone  : NoProtect, { inputmask = '"+7"(999)999"-"9999' }, {Font={BackColor=if(trim(zayavka.phone) <> '',0,ColorNeed)}};
  zayavka.email  : NoProtect, {Font={BackColor=if(trim(zayavka.email) <> '',0,ColorNeed)}};
buttons
  cmValue1 , , ,'Утвердить',,sci1Esc;
<<
  `Дата документа`  .@@@@@@@@@@@ `Номер` .@@@@@@@@@ `Статус`  .@@@@@@@@@@@@@@@@@@@   <.Утвердить.>
   `Автор `   .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ `Дата создания    `.@@@@@@@@@@@@@@@
   `Утвердил` .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ `Дата утверждения `.@@@@@@@@@@@@@@@
                                  `Дата передачи во внеш. систему`.@@@@@@@@@@@@@@@

  `Сотрудник    `   .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
  `Подразделение`   .@@@@@@@@@@@ .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
  `Система лимита  `.@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
  `Категория лимита`.@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

            телефон .@@@@@@@@@@@@@@@@@@
            E-Mail  .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

>>
end;
Handleevent
  cmPrintDoc: {
        processcommand(cmPrintDoc);
      }
  cmvalue1: {
    AgreeZayavka;
  }

end;
end;
//------------------------------------------------------
/*
Function MakeDoc(  _CGP_SCUD_PERS  : comp//.Nrec
                    ;_DOCDATE        : date
                    ;_CLIMITCATEGORY : comp
                    ;_WTYPEDOC       : word
                    ):boolean;
{

}
*/
  //-------------------------------------
  #doc
    Редактировать документ
  #end
  Function EditDoc (_pGP_IIKO_Doc:comp) :boolean;
  { Result:=false;
    if getfirst Zayavka where (( _pGP_IIKO_Doc == Zayavka.Nrec ))<>tsok exit;
    pGP_IIKO_Doc :=_pGP_IIKO_Doc;
    //mAddBounds(tbbyNrec)
    if not BoundActive(tbbyNrec) PushBounds(tbbyNrec);

//    SetVisibleRun(true);
    PositionChanged;
    RunWindowModal(wnEdit);
    Result:=true;
  } //Function EditDoc (_pGP_SCUD_Doc:comp) :boolean;





Procedure EnableDisableInsert(_Enable:boolean);
{ if _Enable
  { EnableCommand(cmInsert);
    EnableCommand(cmEdit);
    EnableCommand(cmAddNewRec);
    EnableCommand(cmInsertRecord);
    EnableCommand(cmSetDefault);


  }
  else
  { DisableCommand(cmInsert);
    DisableCommand(cmEdit);
    DisableCommand(cmAddNewRec);
    DisableCommand(cmInsertRecord);
    DisableCommand(cmSetDefault);
  }

}//Function EnableDisableInsert(_Enable:boolean);

//------------------------------------
// Запретить/разрешить удаление
//------------------------------------

Procedure SetDocStateStart;
{ EnableDisableInsert(true);
}

Procedure LoadInterface;
{  //-----------------------------
boVisibleRun := TRUE;




  _Kau_IIKOLIMIT := 0;
  _Kau_IIKOLIMIT := wgettune('GP_OWN.GP_OWN.PITANIE.KAULIMIT');

  _Kau_system    := 0
  _Kau_system := wgettune('GP_OWN.GP_OWN.PITANIE.SYSTEM');

  if _Kau_IIKOLIMIT = 0 {
     message('В настройке не указана аналитика лимитов питания',error)
   }
  if _Kau_system = 0 {
     message('В настройке не указана система питания',error)
   }

  //timelog(GetInterfaceName+'->LoadInterface:003 ');
  //------------------------------
  boDataProtector:=false;
  if boVisibleRun
  {
  }
  Status_Init;
  if not NullVipRef(Status)
  pStatus_GetDefault:=GetStatus_Default();
  //------------------
  //timelog(GetInterfaceName+'->LoadInterface:006');
  //-----------------------------
  //-----------------------------
  //-------------------------
  fCurMainFormatEdit:=GetCurrentFormat;
  SetDocStateStart;
  //-------------------------
  /*  20190911 Фролова Е.С. сказала убрать ограничения по подразделениям ЗП
   if(getfirst ZU where upcase(USERNAME) = upcase(ZU.OWNNAME) and ZU.podrshare = '+')= tsOK
   {
   _try
    {
     delete all tPodr;
     sql
      select
       UR.crecds
      from USERRIGHTS UR
       inner join ZAR_USER ZU on upper('CB\'+ZU.OWNNAME) = upper('CB\'+:(USERNAME))
                                           and ZU.OWNNAME = UR.OWNNAME
      into tPodr;
    }
    _except
     else {}
    addbounds(tbbuZarPodr);
   }
   */
                       sTitle_InterFace := 'Ввод заявлений на питание';
                       sTitle_Window  := 'Редактирование заявления на питание';
                       cfsSetProp('T_SCREDIT_(Для_получения_через_портал)','VISIBLE',false)
                       cfsSetProp('T_SCREDIT_(Для_получения_на_E-MAIL)','VISIBLE',false)

  if boVisibleRun
  {
    if(cfsSetCurrentContainer(cfsGetCurrentContainerSelf) <> cfOk)
    {
    }

  }

//  cfsSetProp('EM_IIKO::EM_ZAYAVPITANIE','Title',sTitle_InterFace);
//  cfsSetProp('BRDOC','Title',sTitle_InterFace);
  cfsSetProp('WNEDIT','Title',sTitle_Window)
  SetWindowTitle(wnMainWindow,sTitle_InterFace);
   _try
   {
     delete all tmp_Limitpitanie;
     var _codeLike : string = 'limit%'
    sql
      select
        spkau.nrec
      , spkau.code
      , spkau.name
      from spkau
      where
          spkau.kodgrkau = :(_Kau_IIKOLIMIT)
      and spkau.code like :(_codeLike)
      into tmp_Limitpitanie;
   }
  _except
   else {}
  _finally{}

  //timelog(GetInterfaceName+'->LoadInterface:Final');
} //Procedure LoadInterface(_wVisibleRun:boolean);


procedure AgreeZayavka; {
    if zayavka.STATUS <> pStatus_GetDefault exit;// 'ОФОРМЛЯЕМЫЙ'

      if Zayavka.CLIMITCATEGORY = 0 {
         Message('Не выбран лимит питания',error);
         exit;
       }
      if Zayavka.cPersons = 0 {
         Message('Не выбран сотрудник',error);
         exit;
       }

      if trim(zayavka.phone) = '' {
        Message('Не указан телефон',error);
        exit;
      }

      if trim(zayavka.email) = '' {
         Message('Не указан e-Mail',error);
         exit;
       }

      set zayavka.STATUS       := 1;
      set zayavka.CUSERAPPROVE := userID;
      set zayavka.APPROVE_DATE := _CurDateTime;
     update current Zayavka;
     SetEditMode(CanEditTbl);
    ReReadRecord(#Zayavka);
//    oGP_Log.Done(true);
}

Procedure PrintDoc; {
  if zayavka.status = pStatus_GetDefault {
        Message('Печать возможна только в статусе "На утверждении"',error)
        exit;
    }

  RunFReport(ZayavZarList_DTS, '', False);
}


  //---------------------------------------------
  // Загрузчик интерфейса
  //---------------------------------------------
Browse brDoc '' (,,sci1478Esc)
//show at (,,,15);
Table Zayavka;
Fields {Font={Color=if(Zayavka.output_DATE = _datetime(0,0,0,0,0,0,0)
                       ,if(zayavka.APPROVE_DATE = _datetime(0,0,0,0,0,0,0)
                          , 0
                          , 13
                          )
                       ,3)}};
  zayavka.DocDate      'Дата'  ('Дата документа')  : [12] ,Protect,NoDel;
  zayavka.NoDoc        'Номер' ('номер документа') : [10] ,Protect,NoDel;
  StatusName          'Статус' ('статус документа ',,sci13Esc): [10],Protect,NoDel;
  zayavka.INPUT_DATE   'Дата ввода'  ('Дата ввода документа')  : [12] ,Protect,NoDel;
  zayavka.APPROVE_DATE 'Дата утверждения'  ('Дата утверждения документа')  : [12] ,Protect,NoDel;
  zayavka.output_DATE 'Дата передачи в IIKO'  ('Дата передачи в IIKO')  : [12] ,Protect,NoDel;
  PersonsFio           'ФИО'  ('ФИО сотрудника')  : [12] ,Protect,NoDel;
  Pers.sex             'Пол'  ('Пол сотрудника')  : [2] ,Protect,NoDel;
  podr.code             'Подр.' ('Код подразделения') : [10] ,Protect,NoDel;
  limitcategory        'Лимит питания' ('Категория лимита питания') : [10] ,Protect,NoDel;

end;//Browse
//******************************************************************************
// HandleEvent таблиц
//******************************************************************************
TableEvent table Zayavka
cmSetDefault:
{ //if GP_SCUD_Doc.cStatus<>pStatus_GetDefault
  //{ exit;
  //}
  MakeBufferZayavka;
  Insert current Zayavka;
  SetNew(false);
  SetEditMode(CanEditTbl());
  PutCommand(cmEdit)
}
cmCheckRecord:
{
  //if boWinEdit
  //  if Not MyCheckRecord abort;
}
cmDoGetNext:
{ //if boWinEdit
  //  if Not MyCheckRecord abort;
}
cmDoGetPrev:
{ //if boWinEdit
  //  if Not MyCheckRecord abort;
}
cmCheckField:
{
   updatetable;
}
cmInsertRecord:
{ Insert Current Zayavka;
}
cmUpdateRecord:
{ Update Current Zayavka;
}
cmDeleteRecord:
{ if Zayavka.Status<>pStatus_GetDefault
  { message('Удаление доступно только в оформляемом статусе')
  }
  else
  { if message('Удалить документ '+Zayavka.NoDoc+'?', YesNo)=cmYes
    {  if not true //проверить есть ли уже питание по человеку
       { message(  'По сотруднику есть суммы питания'
          +chr(13)+'Удаление запрещено!');
         exit;
       }
       delete Current Zayavka;
    }
  }
}

cmPositionChanged:
{ PositionChanged;
}
end; //GP_SCUD_Doc


Window wnGetLimitpitanie 'Выбор категории питания' (,,sci1Esc) ,DoAccept,Cyan;
Show at (,,60,15);
Browse brGetLimitpitanie;
Table tmp_Limitpitanie;
Fields
  tmp_Limitpitanie.name 'Наименование':[40],Protect,NoDel;
  tmp_Limitpitanie.Code 'Код':[20],Protect,NoDel;
end;//Browse brReason;
end;//Window wnGetReason

//------------------------------
//******************************************************************************
// HandleEvent самого интерфейса
//******************************************************************************
  HandleEvent
    //-----------------------------
    cmInit: {
      LoadInterFace;
      ClearFuncCache;
      //--------------------------

     //--------------------------

      if cRec>0
      { if getfirst Zayavka where (( cRec == Zayavka.nrec ))=tsok {}
      }

      //-------------------------

      rereadrecord(#Zayavka);
    }
    //-----------------------------
    cmOnVipLoad:
    { //LoadInterFace(false);
    }
    //-----------------------------
    cmDone:
    {
      //UnLoadInterFace(true);
    }
    //-----------------------------
    cmOnVipUnLoad:
    { //UnLoadInterFace(false);
    }
    //-----------------------------
    cmDefault:
    {
      PutCommand(cmEdit);
    }
    cmEdit:
    {  RunWindowModal(wnEdit);
    }
    cmPick:
    {
      case curField of
      #PersonsFio:
      {
       if //RunInterface(GP_STAFF::GP_SCUD_PersVib,cgiPick,Zayavka.CGP_SCUD_PERS,0,0)<>cmCancel
       iGetKau.GetCodeKau(cgiPick,cgKau_Persons,Zayavka.cpersons)<>cmCancel
        {
          Set Zayavka.cpersons := Zayavka.cpersons;
          if getfirst Pers = tsOK then set zayavka.cPodr := pers.department;
          set zayavka.email  :=if(isValid(tneMail), eMail.eMail,'');
          SetModified(true);
          UpdateTable;// ломает базу;
        }
      }
      #limitcategory: {
         if _Kau_IIKOLIMIT = 0 {
           message('В настройке не указана аналитика лимитов питания',error)
         }
         else
         {

             /*
             if RunWindowModal(wnGetLimitpitanie)=cmDefault
              {
                set Zayavka.CLIMITCATEGORY := tmp_Limitpitanie.nrec
                SetModified(true);
                UpdateTable;// ломает базу;
              }
             */
             if iGetKau.GetCodeKau(cgiPick,_Kau_IIKOLIMIT,Zayavka.CLIMITCATEGORY)<>cmCancel
             {
              set Zayavka.CLIMITCATEGORY := Zayavka.CLIMITCATEGORY
              SetModified(true);
              UpdateTable;// ломает базу;
           }
         }
       }
       #SystemPitanie: {
         if _Kau_system = 0 {
           message('В настройке не указана система питания',error)
         }
         else
         {
             if iGetKau.GetCodeKau(cgiPick,_Kau_system,Zayavka.cSystem)<>cmCancel
             {
              set Zayavka.cSystem := Zayavka.cSystem
              SetModified(true);
              UpdateTable;// ломает базу;
           }
         }
       }

      end;
    }

    //--------------------------
    cmPickClass:// внешние классификаторы
    {
      if UpdateTable
      case CurTable of
      #Zayavka: RunInterface('C_EXTCLASS::ExClassifier', coGP_ZAYAVKA_PITANIE, Zayavka.nRec);
      end;
      ClearFuncCache;
    }
    //--------------------------
    //--------------------------
    cmPrintDoc : PrintDoc;
    cmFilterSave:
    {

    }
    //--------------------------
    cmPickAttr:// внешние аттрибуты
    {
      if UpdateTable
      case CurTable of
      #Zayavka: RunInterface('C_EXTCLASS::Attribute', coGP_ZAYAVKA_PITANIE, Zayavka.nRec);
      end;
      ClearFuncCache;
    }
    //--------------------------
    cmHotKeys:
    {
      case CurTable of
      #Zayavka: {
        ProcessCommand(RunMenu('GP_IIKO_ZAYAVKA_Main_HotKey_Adm'));
       /*
        if pr_CurUserAdmin
        { ProcessCommand(RunMenu('GP_SCUD_DocEdit_Main_HotKey_Adm'));
        }
        else
        { ProcessCommand(RunMenu('GP_SCUD_DocEdit_Main_HotKey'));
        }
        */
      }
      end;
    }
    cmdelonprotect: {
      stop;abort;exit;

    }
  end;

end.
GP_IIKO_ZAYAVKA_Main_HotKey_Adm Menu
{
// - 'Фильтр на данные'     , cmFilterSave, 'Фильтр на данные', hcProc_NagrKaf, 'Alt+B',kbAltB, scMenuCtx;
- 'Внешняя классификация', cmPickClass, 'Внешняя классификация', hcGkatalM1ExtClass, 'Alt+C', kbAltC, sci1Esc;
- 'Внешние атрибуты'     , cmPickAttr , 'Заполнение внешних атрибутов по данной позиции', hcGkatalM1Attr, 'Alt+A', kbAltA, sci1Esc;

}
